package ktclient

import "testing"

const certificateChain string = `-----BEGIN CERTIFICATE-----
MIIG5jCCBM6gAwIBAgIRAOIds00Lesq/jYqQ1berJw4wDQYJKoZIhvcNAQEMBQAw
SzELMAkGA1UEBhMCQVQxEDAOBgNVBAoTB1plcm9TU0wxKjAoBgNVBAMTIVplcm9T
U0wgUlNBIERvbWFpbiBTZWN1cmUgU2l0ZSBDQTAeFw0yMzA3MTEwMDAwMDBaFw0y
MzEwMDkyMzU5NTlaMCQxIjAgBgNVBAMTGWVwb2NoLjQ2LjEuZGV2LnByb3Rvbi53
dGYwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC14FJj55PXg0u4aHJb
1/uZilCJCutmQI/ZptEcHusY6mkxcDNdKJ3UGA52Gv3IUrOIvC5cxVcYDlhV4Y3E
C/fHbxEwWX13OmdgK4sU1hTTx9d3uPGEGF+6SCAWmLHBGSo+9S/dyhQzz3J3piV9
l9b3ZZ0nRFD3jF3JaPJOs2aYlORJyHpYtAkm7vEYEfUHO8t+c+vZZ0QNb0py2mCI
uopT8Mo6MySYMek7fcIrDHTwIT6aw1ULenqSM3HzdFb7zv3gzVcR6ARyk84SSz/7
wKDNSIzBUnRN1t1UpsUj9yE9zCGUdtmp8pDyNNbhbAiDhZPKx92NWsxOx9ETy7pm
1ERbAgMBAAGjggLqMIIC5jAfBgNVHSMEGDAWgBTI2XhootkZaNU9ct5fCj7ctYaG
pjAdBgNVHQ4EFgQUQJ3BGNv3F9SpE8LtAM2/lBrn6K0wDgYDVR0PAQH/BAQDAgWg
MAwGA1UdEwEB/wQCMAAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMEkG
A1UdIARCMEAwNAYLKwYBBAGyMQECAk4wJTAjBggrBgEFBQcCARYXaHR0cHM6Ly9z
ZWN0aWdvLmNvbS9DUFMwCAYGZ4EMAQIBMIGIBggrBgEFBQcBAQR8MHowSwYIKwYB
BQUHMAKGP2h0dHA6Ly96ZXJvc3NsLmNydC5zZWN0aWdvLmNvbS9aZXJvU1NMUlNB
RG9tYWluU2VjdXJlU2l0ZUNBLmNydDArBggrBgEFBQcwAYYfaHR0cDovL3plcm9z
c2wub2NzcC5zZWN0aWdvLmNvbTCCAQYGCisGAQQB1nkCBAIEgfcEgfQA8gB3AK33
vvp8/xDIi509nB4+GGq0Zyldz7EMJMqFhjTr3IKKAAABiUP8Y/AAAAQDAEgwRgIh
APOCWsYgXTVPKmhF5BdYLb4/l3rcxNFbfqe1+cDGmsE6AiEA+lTbYxs8kmBKynsu
8icSAhPoXsobF1kBfUfatGAPZocAdwB6MoxU2LcttiDqOOBSHumEFnAyE4VNO9Ir
wTpXo1LrUgAAAYlD/GRGAAAEAwBIMEYCIQDjQ4SjJVRd6ctyhc/sWhADbqA2atiw
2+MqJ9Lj65JMwAIhAIIP3U81lNqeGCiLD4X89Ij1ymfrFTGDtv0FdgIQP+/HMIGG
BgNVHREEfzB9ghllcG9jaC40Ni4xLmRldi5wcm90b24ud3RmgmA1MDYwNjJhODFi
NGYyYWU4YWViMmY2ZGQyZDAwM2FkYS5jM2NkMWU4NGEzOWQxOTIyNWE4NjUzZDEw
MTJjZjBkMi4xNjg5MDYyNzQwLjQ2LjEuZGV2LnByb3Rvbi53dGYwDQYJKoZIhvcN
AQEMBQADggIBAFQKG2KE9aaLjSDbCh4mhhmvcuRRe2tgTffN9lCas4IQEjJKaMYB
frL3K7PddznlDKGKsC9z4P9T0jiWu1tsYPwjPBlflN9xV8uYFfmiSdtpEpECmdNF
oI7DijQpldL/lIVObxSHVEfeVfBkDGlS7vaSVEyHBR540KWQOFdPoUkRPNb1yfn2
9liBWfh3muSo9h8ESv+J7T0GCAqmLGVWNFpLXjj8GExozzrjg8LQe9vCFzZivmd2
ZwYXTuMsaFxnsA8PbXpA7Q5mBa7VhkQPyA51EP7Ey7sebzJnJgIe3vSZqMC/b20F
GBhtq03aPkknymwGYLwQwYQufquMZCOxDHVtsFkjuW2fPOvNQnwLiS2A7H7ir5pl
bcXupk4qCBL8ZgsWuFvjmpfiMob7IYx2lKZmYJf0wrURw1oLIvnw+HG63ReN4IsD
8917/iCvPLOw95OYe2EpzUc3/lFHbe1FOyiPa7zy7nC0BaVA33VI51ib3OqrQVmZ
ldZsZ7EgqAYWj9QoIs7RPCpCv/uvWFwR22M1c+IWXkeyAkW/C0fnSm8+WTdUKd7T
PiiRg8DCBqIt2dccdY9PKUnqBMjVidGjBG1J0aAKRGwoBZZhty0ReUJGTN2kQ/tc
kcwTqDVlsOGSEAyi2T+51fYUjmqeFlb+AvA9uhcESpyL1rYit+n6Ulbf
-----END CERTIFICATE-----

-----BEGIN CERTIFICATE-----
MIIG1TCCBL2gAwIBAgIQbFWr29AHksedBwzYEZ7WvzANBgkqhkiG9w0BAQwFADCB
iDELMAkGA1UEBhMCVVMxEzARBgNVBAgTCk5ldyBKZXJzZXkxFDASBgNVBAcTC0pl
cnNleSBDaXR5MR4wHAYDVQQKExVUaGUgVVNFUlRSVVNUIE5ldHdvcmsxLjAsBgNV
BAMTJVVTRVJUcnVzdCBSU0EgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwHhcNMjAw
MTMwMDAwMDAwWhcNMzAwMTI5MjM1OTU5WjBLMQswCQYDVQQGEwJBVDEQMA4GA1UE
ChMHWmVyb1NTTDEqMCgGA1UEAxMhWmVyb1NTTCBSU0EgRG9tYWluIFNlY3VyZSBT
aXRlIENBMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAhmlzfqO1Mdgj
4W3dpBPTVBX1AuvcAyG1fl0dUnw/MeueCWzRWTheZ35LVo91kLI3DDVaZKW+TBAs
JBjEbYmMwcWSTWYCg5334SF0+ctDAsFxsX+rTDh9kSrG/4mp6OShubLaEIUJiZo4
t873TuSd0Wj5DWt3DtpAG8T35l/v+xrN8ub8PSSoX5Vkgw+jWf4KQtNvUFLDq8mF
WhUnPL6jHAADXpvs4lTNYwOtx9yQtbpxwSt7QJY1+ICrmRJB6BuKRt/jfDJF9Jsc
RQVlHIxQdKAJl7oaVnXgDkqtk2qddd3kCDXd74gv813G91z7CjsGyJ93oJIlNS3U
gFbD6V54JMgZ3rSmotYbz98oZxX7MKbtCm1aJ/q+hTv2YK1yMxrnfcieKmOYBbFD
hnW5O6RMA703dBK92j6XRN2EttLkQuujZgy+jXRKtaWMIlkNkWJmOiHmErQngHvt
iNkIcjJumq1ddFX4iaTI40a6zgvIBtxFeDs2RfcaH73er7ctNUUqgQT5rFgJhMmF
x76rQgB5OZUkodb5k2ex7P+Gu4J86bS15094UuYcV09hVeknmTh5Ex9CBKipLS2W
2wKBakf+aVYnNCU6S0nASqt2xrZpGC1v7v6DhuepyyJtn3qSV2PoBiU5Sql+aARp
wUibQMGm44gjyNDqDlVp+ShLQlUH9x8CAwEAAaOCAXUwggFxMB8GA1UdIwQYMBaA
FFN5v1qqK0rPVIDh2JvAnfKyA2bLMB0GA1UdDgQWBBTI2XhootkZaNU9ct5fCj7c
tYaGpjAOBgNVHQ8BAf8EBAMCAYYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHSUE
FjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwIgYDVR0gBBswGTANBgsrBgEEAbIxAQIC
TjAIBgZngQwBAgEwUAYDVR0fBEkwRzBFoEOgQYY/aHR0cDovL2NybC51c2VydHJ1
c3QuY29tL1VTRVJUcnVzdFJTQUNlcnRpZmljYXRpb25BdXRob3JpdHkuY3JsMHYG
CCsGAQUFBwEBBGowaDA/BggrBgEFBQcwAoYzaHR0cDovL2NydC51c2VydHJ1c3Qu
Y29tL1VTRVJUcnVzdFJTQUFkZFRydXN0Q0EuY3J0MCUGCCsGAQUFBzABhhlodHRw
Oi8vb2NzcC51c2VydHJ1c3QuY29tMA0GCSqGSIb3DQEBDAUAA4ICAQAVDwoIzQDV
ercT0eYqZjBNJ8VNWwVFlQOtZERqn5iWnEVaLZZdzxlbvz2Fx0ExUNuUEgYkIVM4
YocKkCQ7hO5noicoq/DrEYH5IuNcuW1I8JJZ9DLuB1fYvIHlZ2JG46iNbVKA3ygA
Ez86RvDQlt2C494qqPVItRjrz9YlJEGT0DrttyApq0YLFDzf+Z1pkMhh7c+7fXeJ
qmIhfJpduKc8HEQkYQQShen426S3H0JrIAbKcBCiyYFuOhfyvuwVCFDfFvrjADjd
4jX1uQXd161IyFRbm89s2Oj5oU1wDYz5sx+hoCuh6lSs+/uPuWomIq3y1GDFNafW
+LsHBU16lQo5Q2yh25laQsKRgyPmMpHJ98edm6y2sHUabASmRHxvGiuwwE25aDU0
2SAeepyImJ2CzB80YG7WxlynHqNhpE7xfC7PzQlLgmfEHdU+tHFeQazRQnrFkW2W
kqRGIq7cKRnyypvjPMkjeiV9lRdAM9fSJvsB3svUuu1coIG1xxI1yegoGM4r5QP4
RGIVvYaiI76C0djoSbQ/dkIUUXQuB8AL5jyH34g3BZaaXyvpmnV4ilppMXVAnAYG
ON51WhJ6W0xNdNJwzYASZYH+tmCWI+N60Gv2NNMGHwMZ7e9bXgzUCZH5FaBFDGR5
S9VWqHB73Q+OyIVvIbKYcSc2w/aSuFKGSA==
-----END CERTIFICATE-----`

func TestEpochVerification(t *testing.T) {
	t.Parallel()
	// given
	epoch := Epoch{
		EpochID:           46,
		PreviousChainHash: "9624e880fe4b49b45fc15ca7e16b7ed8a846724a1802b2a2ca9d749770b00f4b",
		CertificateChain:  certificateChain,
		CertificateIssuer: 1,
		TreeHash:          "65e8dd7b133f7a02fe0e249928f7fdf1a21df8a5923234c97e0177f0f56a194c",
		ChainHash:         "506062a81b4f2ae8aeb2f6dd2d003adac3cd1e84a39d19225a8653d1012cf0d2",
		CertificateTime:   1_689_062_740,
	}
	expectedNotBefore := 1689033600
	// when
	notBefore, err := VerifyEpoch(
		&epoch,
		"dev.proton.wtf",
		1_689_062_740,
	)
	// then
	if err != nil {
		t.Fatalf("Could not verify epoch: %v", err)
	}
	if notBefore != int64(expectedNotBefore) {
		t.Fatalf("Expected %d, got %d", expectedNotBefore, notBefore)
	}
}
